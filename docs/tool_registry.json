[
  {
    "name": "fs.read",
    "category": "filesystem",
    "description": "Read the contents of a file from disk.",
    "purpose": "Inspect existing code before making changes.",
    "when_to_use": [
      "Before modifying a file",
      "When debugging code behavior",
      "When validating assumptions about implementation"
    ],
    "when_not_to_use": [
      "If file content is already available in context",
      "To explore the repository blindly",
      "To read more than one file in the first iteration"
    ],
    "dependencies": {
      "allowed_phases": ["PLANNING", "EXECUTION"],
      "forbidden_phases": ["DECISION"],
      "produces": ["file_content"],
      "required_before": []
    },
    "inputs": {
      "type": "object",
      "properties": {
        "path": { "type": "string", "description": "Relative path to file inside repo" }
      },
      "required": ["path"]
    },
    "outputs": {
      "type": "object",
      "properties": {
        "path": { "type": "string" },
        "content": { "type": "string" }
      },
      "required": ["path", "content"]
    },
    "side_effects": ["Reads from disk", "Does not modify filesystem"],
    "safety_rules": [
      "Must not be called more than once in the first planning iteration",
      "Must not be used to scan directories"
    ],
    "examples": {
      "valid": [
        {
          "input": { "path": "lib/devagent/tool_registry.rb" },
          "output": { "path": "lib/devagent/tool_registry.rb", "content": "..." }
        }
      ],
      "invalid": [{ "input": {}, "reason": "Missing required path" }]
    }
  },
  {
    "name": "fs.write",
    "category": "filesystem",
    "description": "Propose modifications to an existing file (logical only).",
    "purpose": "Safely change code after inspection. The controller converts this intent into a diff and applies it.",
    "when_to_use": [
      "After reading a file to propose a small, targeted change",
      "When implementing a fix described in the plan"
    ],
    "when_not_to_use": [
      "Before reading the same file",
      "To rewrite an entire file",
      "To make large, sweeping refactors in one step"
    ],
    "dependencies": {
      "required_tools": ["fs.read"],
      "required_outputs": ["file_content"],
      "requires_same_path": true
    },
    "inputs": {
      "type": "object",
      "properties": {
        "path": { "type": "string" },
        "intent": { "type": "string", "description": "What change is being made and why" }
      },
      "required": ["path", "intent"]
    },
    "outputs": {
      "type": "object",
      "properties": {
        "proposed_change": { "type": "string", "description": "Unified diff generated by controller" }
      }
    },
    "side_effects": ["None (controller converts to diff)"],
    "safety_rules": [
      "Must depend on fs.read of the same path",
      "Must not rewrite entire file",
      "Controller must validate diff before applying"
    ],
    "examples": {
      "valid": [
        {
          "input": {
            "path": "lib/devagent/tool_registry.rb",
            "intent": "Expose only logical tools to the planner"
          },
          "output": { "proposed_change": "--- a/lib/devagent/tool_registry.rb\n+++ b/lib/devagent/tool_registry.rb\n@@ ..." }
        }
      ],
      "invalid": [
        {
          "input": { "path": "lib/devagent/tool_registry.rb" },
          "reason": "Missing required intent"
        }
      ]
    }
  },
  {
    "name": "exec.run",
    "category": "execution",
    "description": "Run a safe shell command and capture output.",
    "purpose": "Run tests, linters, or simple diagnostics.",
    "when_to_use": ["To run test suites", "To validate a fix", "To reproduce a reported error"],
    "when_not_to_use": ["To install dependencies", "To push code", "To modify system state"],
    "dependencies": { "allowed_phases": ["EXECUTION"], "produces": ["command_output"] },
    "inputs": {
      "type": "object",
      "properties": { "command": { "type": "string", "description": "Shell command (allowlisted)" } },
      "required": ["command"]
    },
    "outputs": {
      "type": "object",
      "properties": {
        "stdout": { "type": "string" },
        "stderr": { "type": "string" },
        "exit_code": { "type": "integer" }
      },
      "required": ["stdout", "stderr", "exit_code"]
    },
    "side_effects": ["Consumes CPU", "May read files", "Does not modify files"],
    "safety_rules": [
      "Command must match allowlist",
      "Block rm, sudo, git push, curl | sh",
      "Hard timeout enforced",
      "Max output size enforced"
    ],
    "examples": {
      "valid": [
        {
          "input": { "command": "bundle exec rspec" },
          "output": { "stdout": "...", "stderr": "", "exit_code": 0 }
        }
      ],
      "invalid": [{ "input": { "command": "rm -rf /" }, "reason": "Blocked by denylist" }]
    }
  },
  {
    "name": "diagnostics.error_summary",
    "category": "diagnostics",
    "description": "Summarize an error output.",
    "purpose": "Extract likely root cause from logs without executing anything.",
    "when_to_use": [
      "After a failing exec.run step to extract the root cause",
      "When stderr is long and needs reduction"
    ],
    "when_not_to_use": ["When there is no stderr", "To replace actually reading relevant code"],
    "dependencies": { "produces": ["error_summary"] },
    "inputs": {
      "type": "object",
      "properties": { "stderr": { "type": "string" } },
      "required": ["stderr"]
    },
    "outputs": {
      "type": "object",
      "properties": {
        "root_cause": { "type": "string" },
        "confidence": { "type": "number" }
      },
      "required": ["root_cause", "confidence"]
    },
    "side_effects": ["None"],
    "safety_rules": ["Must not fabricate output; use only provided stderr"],
    "examples": {
      "valid": [
        {
          "input": { "stderr": "NameError: uninitialized constant Foo" },
          "output": {
            "root_cause": "Foo constant is missing or not required/loaded",
            "confidence": 0.7
          }
        }
      ],
      "invalid": [{ "input": {}, "reason": "Missing required stderr" }]
    }
  },
  {
    "name": "fs.delete",
    "category": "filesystem",
    "description": "Delete a file inside the repo (requires prior read).",
    "purpose": "Remove files safely after inspection.",
    "dependencies": { "required_tools": ["fs.read"], "requires_same_path": true },
    "inputs": {
      "type": "object",
      "properties": { "path": { "type": "string" } },
      "required": ["path"]
    },
    "outputs": {
      "type": "object",
      "properties": { "ok": { "type": "boolean" } }
    },
    "side_effects": ["Modifies filesystem"],
    "safety_rules": ["Must depend on fs.read of same path"],
    "examples": { "valid": [], "invalid": [] }
  }
]

